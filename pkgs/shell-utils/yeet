#!/usr/bin/env bash
set -euo pipefail

# Rebuilt yeet: AI-powered Git & PR Workflow
# Dependencies: git, gh CLI, and one of (claude, opencode, gemini)

# Configuration
DEFAULT_BRANCH="main"
CURRENT_BRANCH=$(git branch --show-current)

err() { echo "yeet error: $*" >&2; exit 1; }
info() { echo "yeet: $*" >&2; }

# FR1 & FR2: Guard and check for staged changes [18, 33]
git rev-parse --is-inside-work-tree &>/dev/null |

| err "Not in a git repository."
if git diff --cached --quiet; then
    info "No changes staged. Attempting to stage all changes..."
    git add -A
    if git diff --cached --quiet; then err "Nothing to commit."; fi
fi

# Multi-model AI orchestration [17, 19]
ai_query() {
    local prompt="$1"
    local diff_context
    diff_context=$(git diff --cached | head -n 1000) # Context limit [32]

    if command -v claude &>/dev/null; then
        echo "$diff_context" | claude -p --no-session-persistence "$prompt"
    elif command -v opencode &>/dev/null; then
        opencode run "$prompt. Here is the diff: $diff_context"
    elif command -v gemini &>/dev/null; then
        echo "$diff_context" | gemini "$prompt"
    else
        err "No AI CLI found (claude, opencode, or gemini required)."
    fi
}

# Generate Conventional Commit Message [25, 34]
info "Generating commit message..."
COMMIT_MSG=$(ai_query "Generate a single-line conventional commit message for this diff. Use imperative mood. No markdown.")

# FR2: Commit with signing and DCO [40, 41]
git commit -s -m "$COMMIT_MSG"

# FR3: PR Automation [32, 42]
if [ "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" ]; then
    info "On branch '$CURRENT_BRANCH'. Pushing and creating PR..."
    git push -u origin "$CURRENT_BRANCH"

    # Generate Spicy PR Body [19, 33]
    PR_PROMPT="Generate a PR description for this branch. Be spicy, witty, and use appropriate emojis.
    Include exactly these headers:
    ## Motivation
    ## Changes
    ## Expected result"
    
    PR_BODY=$(ai_query "$PR_PROMPT")
    
    # Create PR via gh CLI [32, 37]
    gh pr create --title "$COMMIT_MSG" --body "$PR_BODY"
else
    info "On default branch. Changes committed and signed."
fi