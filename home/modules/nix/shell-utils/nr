#!/usr/bin/env bash
set -euo pipefail

# Run a package from this flake's pinned nixpkgs without updating channels
# Usage: nr <pkg> [-- args]
nr() {
  local pkg="$1"; shift || true
  if [[ -z "$pkg" ]]; then
    echo "usage: nr <pkg> [-- args]" >&2
    exit 1
  fi

  flake_path="$HOME/src/github.com/jonpulsifer/dotfiles"

  if [[ "$(uname)" == "Linux" ]]; then
    if [[ -d "$HOME/src/github.com/jonpulsifer/infra" ]]; then
      flake_path="$HOME/src/github.com/jonpulsifer/infra"
    elif [[ -d "/etc/nixos" ]]; then
      flake_path="/etc/nixos"
    fi
  fi

  nix run path:$flake_path#''${pkg} -- "$@"
}

nr "$@"
